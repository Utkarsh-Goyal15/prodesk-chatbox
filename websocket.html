<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body style="background-color:darkblue;">
    <div style="width:50vw;padding:30px;background-color:lightblue;">
        <ul id="chat">
        </ul>
    </div>
    <p id="warn" style="color:white"></p>
    <input id="message" type="text" placeholder="Enter Message"/>
    <button onclick="sendMessage()">Send</button>
</body>
</html>

<script>
    function getHistory(){
        setTimeout(async () => {
            const chat=document.getElementById('chat')
            let response=await fetch('http://localhost:4000/api/v1/chatbox/9759781780/7466850778');
            if(!response.ok){
                chat.textContent='Error occur in getting chat';
            }else{
                const data =await response.json();
                chat.innerHTML='';
                data.map(
                    (messages)=>{
                        console.log(messages);
                        color=messages.sender==7466850778?"#1a85ab":"white";
                        margin=messages.sender==7466850778?"50%":"0";
                        chat.innerHTML+=`<li style="background-color:${color};border-radius:10%;padding:6px;margin:5px;width:30%;margin-left:${margin}">${messages.message}</li>`;
                    }
                )
            }
        }, 50);
    }
    window.addEventListener('load',getHistory);
    const socket=new WebSocket('ws://localhost:8000');
    
    const waitToConnect=(message)=>{
        setTimeout(() => {
            if(socket.readyState===1){
                socket.send(message);
                getHistory();
            }else{
                document.getElementById('warn').innerText='Sending...'
                waitToConnect(message);
            }
        }, 5);
    }

    const sendMessage=()=>{        
        const message=document.getElementById('message').value;
        document.getElementById('message').value='';
        const data=JSON.stringify({
            sender:9759781780,
            receiver:7466850778,
            message:message
        });
        if(socket.readyState===1){
            socket.send(data);
            getHistory();
        }else{
            document.getElementById('warn').innerText='Sending...'
            waitToConnect(data);
        }
    }

    

</script>